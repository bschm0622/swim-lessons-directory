---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/ui/Section.astro";
import Card from "@/components/ui/Card.astro";
import CardHeader from "@/components/ui/CardHeader.astro";
import CardTitle from "@/components/ui/CardTitle.astro";
import CardDescription from "@/components/ui/CardDescription.astro";
import CardContent from "@/components/ui/CardContent.astro";
import Badge from "@/components/ui/Badge.astro";
import Button from "@/components/ui/Button.astro";
import SchemaMarkup from "@/components/SchemaMarkup.astro";
import allSchools from "@/data/swim-schools.json";
import { getSpecialtyByCategoryName } from "@/utils/specialty";

export async function getStaticPaths() {
	// Extract unique states
	const stateMap = new Map();

	allSchools.forEach(school => {
		const addressParts = school.address.split(',').map(p => p.trim());
		const stateWithZip = addressParts[addressParts.length - 2] || '';
		const stateAbbrev = stateWithZip.split(' ')[0];

		if (stateAbbrev) {
			// Map state abbreviations to full names
			const stateNames: Record<string, string> = {
				'IN': 'Indiana',
				'TX': 'Texas',
				'CA': 'California',
				'NY': 'New York',
				'FL': 'Florida',
				// Add more as needed
			};

			const stateName = stateNames[stateAbbrev] || stateAbbrev;
			const stateSlug = stateName.toLowerCase().replace(/\s+/g, '-');

			if (!stateMap.has(stateSlug)) {
				stateMap.set(stateSlug, {
					slug: stateSlug,
					name: stateName,
					abbrev: stateAbbrev,
					schools: []
				});
			}

			stateMap.get(stateSlug).schools.push(school);
		}
	});

	return Array.from(stateMap.values()).map(state => ({
		params: { state: state.slug },
		props: { state }
	}));
}

const { state } = Astro.props;

// Group schools by city
const citiesMap = new Map();

state.schools.forEach(school => {
	const addressParts = school.address.split(',').map(p => p.trim());
	const city = addressParts[addressParts.length - 3] || 'Unknown';

	if (!citiesMap.has(city)) {
		citiesMap.set(city, []);
	}
	citiesMap.get(city).push(school);
});

const cities = Array.from(citiesMap.entries()).map(([name, schools]) => ({
	name,
	slug: name.toLowerCase().replace(/\s+/g, '-'),
	schools,
	topRated: schools.sort((a, b) => b.rating - a.rating).slice(0, 3)
})).sort((a, b) => a.name.localeCompare(b.name));

// Extract unique specialties available in this state
const allCategories = new Set<string>();
state.schools.forEach(school => {
	school.categories.forEach(cat => allCategories.add(cat));
});

const availableSpecialties = Array.from(allCategories)
	.map(cat => getSpecialtyByCategoryName(cat))
	.filter(s => s !== undefined)
	.sort((a, b) => a.name.localeCompare(b.name));
---

<Layout
	title={`Swim Lessons in ${state.name} - Find the Best Programs`}
	description={`Discover ${state.schools.length} swim schools across ${cities.length} cities in ${state.name}. Compare programs, read reviews, and find the perfect swim lessons for your family.`}
>
	<!-- Schema Markup for SEO -->
	<SchemaMarkup
		type="breadcrumb"
		slot="head"
		breadcrumbs={[
			{ name: 'Home', url: '/' },
			{ name: state.name, url: `/${state.slug}` }
		]}
	/>

	<!-- Compact Header -->
	<div class="border-b border-border bg-background">
		<Section class="py-6">
			<!-- Breadcrumb -->
			<nav class="mb-4 text-sm">
				<ol class="flex items-center gap-2">
					<li><a href="/" class="text-muted-foreground hover:text-primary">Home</a></li>
					<li class="text-muted-foreground">/</li>
					<li class="text-foreground font-medium">{state.name}</li>
				</ol>
			</nav>

			<h1 class="text-3xl md:text-4xl font-bold mb-2 text-foreground">
				Swim Lessons in {state.name}
			</h1>

			<p class="text-base text-muted-foreground mb-4">
				{state.schools.length} programs across {cities.length} {cities.length === 1 ? 'city' : 'cities'} • {state.schools.filter(s => s.rating >= 4.5).length} top-rated
			</p>

			<!-- Specialty Filters -->
			{availableSpecialties.length > 1 && (
				<div class="mt-4">
					<p class="text-sm font-semibold text-muted-foreground mb-2">Filter by specialty:</p>
					<div class="flex flex-wrap gap-2">
						{availableSpecialties.map(specialty => (
							<a
								href={`/${specialty.slug}/${state.slug}`}
								class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-card border border-border hover:border-primary text-xs"
							>
								<img src={specialty.icon} alt={specialty.name} class="w-4 h-4 object-contain" />
								<span>{specialty.name}</span>
							</a>
						))}
					</div>
				</div>
			)}
		</Section>
	</div>

	<!-- Cities Section -->
	<Section class="py-8 bg-background">
		<h2 class="text-2xl font-bold mb-6">Top Programs by City</h2>

		<div class="space-y-10">
			{cities.map(city => (
				<div>
					<div class="flex items-center justify-between mb-4">
						<div>
							<h3 class="text-xl font-bold text-foreground">{city.name}</h3>
							<p class="text-sm text-muted-foreground">{city.schools.length} {city.schools.length === 1 ? 'program' : 'programs'}</p>
						</div>
						<Button variant="outline" size="sm" href={`/${state.slug}/${city.slug}`}>
							View all →
						</Button>
					</div>

					<div class="grid md:grid-cols-3 gap-5">
						{city.topRated.map(school => (
							<Card class="hover:shadow-md h-full flex flex-col">
								<CardHeader class="pb-3">
									<div class="flex items-start justify-between gap-3 mb-2">
										<CardTitle class="text-lg leading-tight">
											<a href={`/${state.slug}/${city.slug}/${school.id}`} class="hover:text-primary">
												{school.name}
											</a>
										</CardTitle>
										{school.rating > 0 && (
											<Badge variant="secondary" class="text-xs flex-shrink-0">
												⭐ {school.rating.toFixed(1)}
											</Badge>
										)}
									</div>
								</CardHeader>

								<CardContent class="flex-grow flex flex-col pt-0">
									<p class="text-sm text-muted-foreground mb-3 line-clamp-2">
										{school.shortDescription}
									</p>

									<!-- Categories -->
									<div class="flex flex-wrap gap-1 mb-3 mt-auto">
										{school.categories.slice(0, 2).map(cat => (
											<Badge variant="outline" class="text-xs">
												{cat}
											</Badge>
										))}
										{school.categories.length > 2 && (
											<Badge variant="outline" class="text-xs">
												+{school.categories.length - 2}
											</Badge>
										)}
									</div>

									<Button variant="outline" href={`/${state.slug}/${city.slug}/${school.id}`} size="sm" class="w-full">
										View Details
									</Button>
								</CardContent>
							</Card>
						))}
					</div>

					{city.schools.length > 3 && (
						<div class="mt-3">
							<a
								href={`/${state.slug}/${city.slug}`}
								class="text-sm text-primary hover:underline"
							>
								+ {city.schools.length - 3} more programs in {city.name}
							</a>
						</div>
					)}
				</div>
			))}
		</div>
	</Section>
</Layout>
