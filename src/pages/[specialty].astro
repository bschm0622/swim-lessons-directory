---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/ui/Section.astro";
import Card from "@/components/ui/Card.astro";
import CardHeader from "@/components/ui/CardHeader.astro";
import CardTitle from "@/components/ui/CardTitle.astro";
import CardDescription from "@/components/ui/CardDescription.astro";
import CardContent from "@/components/ui/CardContent.astro";
import Badge from "@/components/ui/Badge.astro";
import Button from "@/components/ui/Button.astro";
import allSchools from "@/data/swim-schools.json";
import { getAllSpecialties, getSpecialtyBySlug, type SpecialtyConfig } from "@/utils/specialty";
import { parseAddress, getStateSlug, STATE_NAMES } from "@/utils/location";

export async function getStaticPaths() {
	const specialtyMap = new Map<string, {
		specialty: SpecialtyConfig;
		schools: typeof allSchools;
		states: Map<string, {
			stateName: string;
			stateSlug: string;
			stateAbbrev: string;
			schools: typeof allSchools;
		}>;
	}>();

	// Build map of specialty slug -> schools by state
	allSchools.forEach(school => {
		school.categories.forEach(categoryName => {
			const specialtyConfig = getAllSpecialties().find(s => s.categoryName === categoryName);
			if (!specialtyConfig) return;

			if (!specialtyMap.has(specialtyConfig.slug)) {
				specialtyMap.set(specialtyConfig.slug, {
					specialty: specialtyConfig,
					schools: [],
					states: new Map(),
				});
			}

			const data = specialtyMap.get(specialtyConfig.slug)!;

			// Group by state
			const addressParts = parseAddress(school.address);

			// Skip schools with invalid/empty address data
			if (!addressParts.stateAbbrev) return;

			const stateSlug = getStateSlug(addressParts.stateAbbrev);

			// Skip if slug is empty
			if (!stateSlug) return;

			data.schools.push(school);

			if (!data.states.has(stateSlug)) {
				data.states.set(stateSlug, {
					stateName: addressParts.stateName,
					stateSlug,
					stateAbbrev: addressParts.stateAbbrev,
					schools: []
				});
			}

			data.states.get(stateSlug)!.schools.push(school);
		});
	});

	// Convert to static paths
	return Array.from(specialtyMap.entries()).map(([slug, data]) => {
		// Convert states Map to Array and sort by state name
		const statesArray = Array.from(data.states.values())
			.map(state => ({
				...state,
				topRated: state.schools
					.sort((a, b) => b.rating - a.rating)
					.slice(0, 3)
			}))
			.sort((a, b) => a.stateName.localeCompare(b.stateName));

		return {
			params: { specialty: slug },
			props: {
				specialty: data.specialty,
				schools: data.schools,
				totalStates: data.states.size,
				states: statesArray
			}
		};
	});
}

const { specialty, schools, totalStates, states } = Astro.props;

// Calculate stats
const topRatedCount = schools.filter((s: any) => s.rating >= 4.5).length;
const totalCities = new Set(schools.map((s: any) => parseAddress(s.address).city)).size;
---

<Layout
	title={`${specialty.seoTitle} - Find Programs Near You`}
	description={`Find ${specialty.seoTitle.toLowerCase()} programs across ${totalStates} ${totalStates === 1 ? 'state' : 'states'} and ${totalCities} ${totalCities === 1 ? 'city' : 'cities'}. Compare top-rated schools, read reviews, and discover the perfect program near you.`}
>
	<!-- Hero Section -->
	<div class="relative min-h-[600px] bg-gradient-to-br from-primary/20 via-secondary/10 to-accent/20 flex items-center">
		<div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMzLjMxNCAwIDYgMi42ODYgNiA2cy0yLjY4NiA2LTYgNi02LTIuNjg2LTYtNiAyLjY4Ni02IDYtNiIgc3Ryb2tlPSJyZ2JhKDAsIDE1MCwgMjAwLCAwLjA1KSIvPjwvZz48L3N2Zz4=')] opacity-50"></div>

		<Section class="relative z-10 py-20">
			<div class="max-w-4xl">
				<!-- Breadcrumb -->
				<nav class="mb-8 text-sm">
					<ol class="flex items-center gap-2">
						<li><a href="/" class="text-muted-foreground hover:text-primary transition-colors">Home</a></li>
						<li class="text-muted-foreground">/</li>
						<li class="text-foreground font-medium">{specialty.name}</li>
					</ol>
				</nav>

				<!-- Icon -->
				<div class="text-6xl mb-6">{specialty.icon}</div>

				<!-- H1 -->
				<h1 class="text-5xl md:text-6xl font-bold mb-6 text-foreground leading-tight">
					Find the Best <span class="text-primary">{specialty.seoTitle}</span>
				</h1>

				<p class="text-xl md:text-2xl text-muted-foreground mb-8 leading-relaxed">
					{specialty.shortDescription}
				</p>

				<!-- Stats -->
				<div class="flex flex-wrap gap-4">
					<div class="bg-card/80 backdrop-blur-sm border-2 border-primary/20 rounded-xl px-6 py-4 hover:border-primary/40 transition-colors">
						<div class="text-3xl font-bold text-primary">{schools.length}</div>
						<div class="text-sm text-muted-foreground font-medium">Programs</div>
					</div>
					<div class="bg-card/80 backdrop-blur-sm border-2 border-primary/20 rounded-xl px-6 py-4 hover:border-primary/40 transition-colors">
						<div class="text-3xl font-bold text-primary">{totalStates}</div>
						<div class="text-sm text-muted-foreground font-medium">{totalStates === 1 ? 'State' : 'States'}</div>
					</div>
					<div class="bg-card/80 backdrop-blur-sm border-2 border-primary/20 rounded-xl px-6 py-4 hover:border-primary/40 transition-colors">
						<div class="text-3xl font-bold text-primary">{totalCities}</div>
						<div class="text-sm text-muted-foreground font-medium">{totalCities === 1 ? 'City' : 'Cities'}</div>
					</div>
					<div class="bg-card/80 backdrop-blur-sm border-2 border-secondary/20 rounded-xl px-6 py-4 hover:border-secondary/40 transition-colors">
						<div class="text-3xl font-bold text-secondary">{topRatedCount}</div>
						<div class="text-sm text-muted-foreground font-medium">Top Rated (4.5+)</div>
					</div>
				</div>
			</div>
		</Section>
	</div>

	<!-- What is this Specialty Section -->
	<Section class="py-16 bg-muted/30">
		<div class="max-w-4xl mx-auto">
			<h2 class="text-3xl md:text-4xl font-bold mb-6 text-center">What Are {specialty.seoTitle}?</h2>
			<p class="text-lg text-muted-foreground mb-8 leading-relaxed">
				{specialty.longDescription}
			</p>

			<!-- Benefits Grid -->
			<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12">
				{specialty.benefits.map(benefit => (
					<div class="bg-card p-6 rounded-xl border border-border/50 hover:border-primary/30 transition-colors">
						<div class="text-2xl mb-3 text-primary">‚úì</div>
						<div class="font-medium text-foreground">{benefit}</div>
					</div>
				))}
			</div>
		</div>
	</Section>

	<!-- Browse by State Section -->
	<Section class="py-16 bg-background">
		<h2 class="text-3xl font-bold mb-8">Find {specialty.seoTitle} Near You</h2>

		<div class="space-y-12">
			{states.map(state => (
				<div>
					<div class="flex items-center justify-between mb-6">
						<div>
							<h3 class="text-2xl font-bold text-foreground">{state.stateName}</h3>
							<p class="text-muted-foreground">{state.schools.length} {state.schools.length === 1 ? 'program' : 'programs'}</p>
						</div>
						<Button variant="outline" href={`/${specialty.slug}/${state.stateSlug}`}>
							View All in {state.stateName}
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M5 12h14"></path>
								<path d="m12 5 7 7-7 7"></path>
							</svg>
						</Button>
					</div>

					<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
						{state.topRated.map(school => (
							<Card class="hover:shadow-lg transition-shadow">
								<CardHeader>
									<div class="flex items-start justify-between mb-2">
										<div class="text-3xl">
											{school.specialFeatures.includes('On-Site Childcare') ? 'üë®‚Äçüë©‚Äçüëß' : 'üèä‚Äç‚ôÄÔ∏è'}
										</div>
										{school.rating > 0 && (
											<Badge variant="secondary" class="text-xs">
												‚≠ê {school.rating.toFixed(1)}
											</Badge>
										)}
									</div>
									<CardTitle>
										<a href={`/${state.stateSlug}/${parseAddress(school.address).city.toLowerCase().replace(/\s+/g, '-')}/${school.id}`} class="hover:text-primary transition-colors">
											{school.name}
										</a>
									</CardTitle>
									<CardDescription class="mt-2">
										{school.categories.slice(0, 2).map(cat => (
											<Badge variant="outline" class="text-xs mr-1 mb-1">
												{cat}
											</Badge>
										))}
									</CardDescription>
								</CardHeader>
								<CardContent>
									<p class="text-sm text-muted-foreground line-clamp-2 mb-3">
										{school.shortDescription}
									</p>
									<div class="text-xs text-muted-foreground mb-3">
										{parseAddress(school.address).city}, {state.stateAbbrev}
									</div>
									<Button variant="outline" href={`/${state.stateSlug}/${parseAddress(school.address).city.toLowerCase().replace(/\s+/g, '-')}/${school.id}`} class="w-full">
										View Details
									</Button>
								</CardContent>
							</Card>
						))}
					</div>

					{state.schools.length > 3 && (
						<div class="mt-4 text-center">
							<a
								href={`/${specialty.slug}/${state.stateSlug}`}
								class="text-primary hover:underline text-sm font-medium"
							>
								+ {state.schools.length - 3} more in {state.stateName}
							</a>
						</div>
					)}
				</div>
			))}
		</div>
	</Section>

	<!-- Who Should Choose This Section -->
	<Section class="py-16 bg-gradient-to-br from-primary/5 via-accent/5 to-secondary/5">
		<div class="max-w-3xl mx-auto text-center">
			<h2 class="text-3xl md:text-4xl font-bold mb-6">
				Is {specialty.seoTitle} Right for You?
			</h2>
			<p class="text-lg text-muted-foreground mb-6">
				Perfect for: {specialty.targetAudience}
			</p>
			<div class="flex flex-wrap gap-3 justify-center">
				{states.slice(0, 4).map(state => (
					<Button size="lg" variant="outline" href={`/${specialty.slug}/${state.stateSlug}`}>
						{state.stateName} Programs
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M5 12h14"></path>
							<path d="m12 5 7 7-7 7"></path>
						</svg>
					</Button>
				))}
			</div>
		</div>
	</Section>
</Layout>
