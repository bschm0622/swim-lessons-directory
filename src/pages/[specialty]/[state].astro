---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/ui/Section.astro";
import Card from "@/components/ui/Card.astro";
import CardHeader from "@/components/ui/CardHeader.astro";
import CardTitle from "@/components/ui/CardTitle.astro";
import CardDescription from "@/components/ui/CardDescription.astro";
import CardContent from "@/components/ui/CardContent.astro";
import Badge from "@/components/ui/Badge.astro";
import Button from "@/components/ui/Button.astro";
import allSchools from "@/data/swim-schools.json";
import { getAllSpecialties, getSpecialtyBySlug, type SpecialtyConfig } from "@/utils/specialty";
import { parseAddress, getStateSlug, getCitySlug, STATE_NAMES } from "@/utils/location";

export async function getStaticPaths() {
	const paths: any[] = [];

	// For each specialty, find all state + specialty combinations
	getAllSpecialties().forEach(specialty => {
		const stateMap = new Map<string, {
			stateName: string;
			stateSlug: string;
			stateAbbrev: string;
			cities: Map<string, {
				cityName: string;
				citySlug: string;
				schools: typeof allSchools;
			}>;
			schools: typeof allSchools;
		}>();

		// Filter schools by specialty and group by state + city
		allSchools.forEach(school => {
			const hasSpecialty = school.categories.includes(specialty.categoryName);
			if (!hasSpecialty) return;

			const addressParts = parseAddress(school.address);

			// Skip schools with invalid/empty address data
			if (!addressParts.stateAbbrev || !addressParts.city) return;

			const stateSlug = getStateSlug(addressParts.stateAbbrev);
			const citySlug = getCitySlug(addressParts.city);

			// Skip if slugs are empty
			if (!stateSlug || !citySlug) return;

			if (!stateMap.has(stateSlug)) {
				stateMap.set(stateSlug, {
					stateName: addressParts.stateName,
					stateSlug,
					stateAbbrev: addressParts.stateAbbrev,
					cities: new Map(),
					schools: []
				});
			}

			const stateData = stateMap.get(stateSlug)!;
			stateData.schools.push(school);

			if (!stateData.cities.has(citySlug)) {
				stateData.cities.set(citySlug, {
					cityName: addressParts.city,
					citySlug,
					schools: []
				});
			}

			stateData.cities.get(citySlug)!.schools.push(school);
		});

		// Create paths for each state
		stateMap.forEach((stateData, stateSlug) => {
			const citiesArray = Array.from(stateData.cities.values())
				.map(city => ({
					...city,
					topRated: city.schools
						.sort((a, b) => b.rating - a.rating)
						.slice(0, 3)
				}))
				.sort((a, b) => a.cityName.localeCompare(b.cityName));

			paths.push({
				params: {
					specialty: specialty.slug,
					state: stateSlug
				},
				props: {
					specialty,
					stateName: stateData.stateName,
					stateSlug,
					stateAbbrev: stateData.stateAbbrev,
					schools: stateData.schools,
					cities: citiesArray
				}
			});
		});
	});

	return paths;
}

const { specialty, stateName, stateSlug, stateAbbrev, schools, cities } = Astro.props;

// Calculate stats
const topRatedCount = schools.filter((s: any) => s.rating >= 4.5).length;
---

<Layout
	title={`${specialty.seoTitle} in ${stateName} - ${schools.length} Programs`}
	description={`Discover ${schools.length} ${specialty.seoTitle.toLowerCase()} programs in ${stateName}. Compare facilities across ${cities.length} ${cities.length === 1 ? 'city' : 'cities'}, read reviews, and find the perfect fit for your family.`}
>
	<!-- Compact Header -->
	<div class="border-b border-border bg-background">
		<Section class="py-6">
			<!-- Breadcrumb -->
			<nav class="mb-4 text-sm">
				<ol class="flex items-center gap-2 flex-wrap">
					<li><a href="/" class="text-muted-foreground hover:text-primary">Home</a></li>
					<li class="text-muted-foreground">/</li>
					<li><a href={`/${specialty.slug}`} class="text-muted-foreground hover:text-primary">{specialty.name}</a></li>
					<li class="text-muted-foreground">/</li>
					<li class="text-foreground font-medium">{stateName}</li>
				</ol>
			</nav>

			<div class="flex items-start gap-4">
				<!-- Icon -->
				<img src={specialty.icon} alt={specialty.name} class="w-14 h-14 object-contain flex-shrink-0" />

				<div class="flex-1">
					<!-- H1 -->
					<h1 class="text-3xl md:text-4xl font-bold mb-2 text-foreground">
						{specialty.seoTitle} in {stateName}
					</h1>

					<p class="text-base text-muted-foreground mb-3">
						{schools.length} programs across {cities.length} {cities.length === 1 ? 'city' : 'cities'} • {topRatedCount} top-rated
					</p>

					<!-- Description -->
					<p class="text-sm text-muted-foreground max-w-3xl">
						{specialty.shortDescription}
					</p>
				</div>
			</div>
		</Section>
	</div>

	<!-- Browse by City Section -->
	<Section class="py-8 bg-background">
		<h2 class="text-2xl font-bold mb-6">Top Programs by City</h2>

		<div class="space-y-10">
			{cities.map(city => (
				<div>
					<div class="flex items-center justify-between mb-4">
						<div>
							<h3 class="text-xl font-bold text-foreground">{city.cityName}</h3>
							<p class="text-sm text-muted-foreground">{city.schools.length} {city.schools.length === 1 ? 'program' : 'programs'}</p>
						</div>
						<Button variant="outline" size="sm" href={`/${specialty.slug}/${stateSlug}/${city.citySlug}`}>
							View all →
						</Button>
					</div>

					<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
						{city.topRated.map(school => (
							<Card class="hover:shadow-md h-full flex flex-col">
								<CardHeader class="pb-3">
									<div class="flex items-start justify-between gap-3 mb-2">
										<CardTitle class="text-lg leading-tight">
											<a href={`/${stateSlug}/${city.citySlug}/${school.id}`} class="hover:text-primary">
												{school.name}
											</a>
										</CardTitle>
										{school.rating > 0 && (
											<Badge variant="secondary" class="text-xs flex-shrink-0">
												⭐ {school.rating.toFixed(1)}
											</Badge>
										)}
									</div>
									<p class="text-xs text-muted-foreground">{school.facilityType}</p>
								</CardHeader>

								<CardContent class="flex-grow flex flex-col pt-0">
									<p class="text-sm text-muted-foreground mb-3 line-clamp-2">
										{school.shortDescription}
									</p>

									<!-- Key Info -->
									<div class="space-y-1.5 mb-3 text-xs">
										{school.phone && (
											<div class="flex items-center gap-2 text-foreground">
												<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0">
													<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
												</svg>
												<span>{school.phone}</span>
											</div>
										)}
										{school.priceTier && school.priceTier !== 'Not Specified' && (
											<div class="flex items-center gap-2 text-foreground">
												<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0">
													<line x1="12" x2="12" y1="2" y2="22"></line>
													<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
												</svg>
												<span>{school.priceTier}</span>
											</div>
										)}
									</div>

									<!-- Categories -->
									<div class="flex flex-wrap gap-1 mb-3 mt-auto">
										{school.categories.slice(0, 2).map(cat => (
											<Badge variant="outline" class="text-xs">
												{cat}
											</Badge>
										))}
										{school.categories.length > 2 && (
											<Badge variant="outline" class="text-xs">
												+{school.categories.length - 2}
											</Badge>
										)}
									</div>

									<Button variant="outline" href={`/${stateSlug}/${city.citySlug}/${school.id}`} size="sm" class="w-full">
										View Details
									</Button>
								</CardContent>
							</Card>
						))}
					</div>

					{city.schools.length > 3 && (
						<div class="mt-3">
							<a
								href={`/${specialty.slug}/${stateSlug}/${city.citySlug}`}
								class="text-sm text-primary hover:underline"
							>
								+ {city.schools.length - 3} more programs in {city.cityName}
							</a>
						</div>
					)}
				</div>
			))}
		</div>
	</Section>

	<!-- SEO Content Footer -->
	<Section class="py-8 border-t border-border bg-muted/10">
		<div class="max-w-3xl">
			<h2 class="text-xl font-bold mb-3">About {specialty.seoTitle} in {stateName}</h2>
			<p class="text-sm text-muted-foreground mb-4">
				{specialty.longDescription}
			</p>
			<div class="text-sm text-muted-foreground">
				<strong>Perfect for:</strong> {specialty.targetAudience}
			</div>
			<div class="mt-4">
				<strong class="text-sm">Key benefits:</strong>
				<ul class="list-disc pl-5 mt-2 space-y-1 text-sm text-muted-foreground">
					{specialty.benefits.slice(0, 4).map(benefit => (
						<li>{benefit}</li>
					))}
				</ul>
			</div>
			<div class="mt-6 flex gap-3">
				<a href={`/${specialty.slug}`} class="text-sm text-primary hover:underline">
					All {specialty.name} →
				</a>
				<a href={`/${stateSlug}`} class="text-sm text-primary hover:underline">
					All programs in {stateName} →
				</a>
			</div>
		</div>
	</Section>
</Layout>
