---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/ui/Section.astro";
import Card from "@/components/ui/Card.astro";
import CardHeader from "@/components/ui/CardHeader.astro";
import CardTitle from "@/components/ui/CardTitle.astro";
import CardDescription from "@/components/ui/CardDescription.astro";
import CardContent from "@/components/ui/CardContent.astro";
import Badge from "@/components/ui/Badge.astro";
import Button from "@/components/ui/Button.astro";
import allSchools from "@/data/swim-schools.json";
import { getAllSpecialties, getSpecialtyBySlug, type SpecialtyConfig } from "@/utils/specialty";
import { parseAddress, getStateSlug, getCitySlug, STATE_NAMES } from "@/utils/location";

export async function getStaticPaths() {
	const paths: any[] = [];

	// For each specialty, find all city combinations
	getAllSpecialties().forEach(specialty => {
		const cityMap = new Map<string, {
			stateName: string;
			stateSlug: string;
			stateAbbrev: string;
			cityName: string;
			citySlug: string;
			schools: typeof allSchools;
		}>();

		// Filter schools by specialty and group by state + city
		allSchools.forEach(school => {
			const hasSpecialty = school.categories.includes(specialty.categoryName);
			if (!hasSpecialty) return;

			const addressParts = parseAddress(school.address);

			// Skip schools with invalid/empty address data
			if (!addressParts.stateAbbrev || !addressParts.city) return;

			const stateSlug = getStateSlug(addressParts.stateAbbrev);
			const citySlug = getCitySlug(addressParts.city);

			// Skip if slugs are empty
			if (!stateSlug || !citySlug) return;

			const key = `${stateSlug}/${citySlug}`;

			if (!cityMap.has(key)) {
				cityMap.set(key, {
					stateName: addressParts.stateName,
					stateSlug,
					stateAbbrev: addressParts.stateAbbrev,
					cityName: addressParts.city,
					citySlug,
					schools: []
				});
			}

			cityMap.get(key)!.schools.push(school);
		});

		// Create paths for each city
		cityMap.forEach((cityData) => {
			paths.push({
				params: {
					specialty: specialty.slug,
					state: cityData.stateSlug,
					city: cityData.citySlug
				},
				props: {
					specialty,
					stateName: cityData.stateName,
					stateSlug: cityData.stateSlug,
					stateAbbrev: cityData.stateAbbrev,
					cityName: cityData.cityName,
					citySlug: cityData.citySlug,
					schools: cityData.schools
				}
			});
		});
	});

	return paths;
}

const { specialty, stateName, stateSlug, stateAbbrev, cityName, citySlug, schools } = Astro.props;

// Sort schools by rating
const sortedSchools = schools.sort((a: any, b: any) => b.rating - a.rating);

// Calculate stats
const topRatedCount = schools.filter((s: any) => s.rating >= 4.5).length;

// Find related specialties available in this city
const allCategoriesInCity = new Set<string>();
schools.forEach((school: any) => {
	school.categories.forEach((cat: string) => allCategoriesInCity.add(cat));
});

const relatedSpecialties = getAllSpecialties()
	.filter(s => s.categoryName !== specialty.categoryName && allCategoriesInCity.has(s.categoryName))
	.slice(0, 3);

// Extract unique categories from these schools
const uniqueCategories = Array.from(allCategoriesInCity);
---

<Layout
	title={`${specialty.seoTitle} in ${cityName}, ${stateAbbrev} - Best Programs`}
	description={`Compare ${schools.length} ${specialty.seoTitle.toLowerCase()} schools in ${cityName}, ${stateName}. Read reviews, check ratings, and find the best program for your needs.`}
>
	<!-- Hero Section -->
	<div class="relative min-h-[500px] bg-gradient-to-br from-primary/20 via-accent/10 to-secondary/20 flex items-center">
		<div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMzLjMxNCAwIDYgMi42ODYgNiA2cy0yLjY4NiA2LTYgNi02LTIuNjg2LTYtNiAyLjY4Ni02IDYtNiIgc3Ryb2tlPSJyZ2JhKDAsIDE1MCwgMjAwLCAwLjA1KSIvPjwvZz48L3N2Zz4=')] opacity-50"></div>

		<Section class="relative z-10 py-20">
			<div class="max-w-5xl">
				<!-- Breadcrumb -->
				<nav class="mb-8 text-sm">
					<ol class="flex items-center gap-2 flex-wrap">
						<li><a href="/" class="text-muted-foreground hover:text-primary transition-colors">Home</a></li>
						<li class="text-muted-foreground">/</li>
						<li><a href={`/${specialty.slug}`} class="text-muted-foreground hover:text-primary transition-colors">{specialty.name}</a></li>
						<li class="text-muted-foreground">/</li>
						<li><a href={`/${specialty.slug}/${stateSlug}`} class="text-muted-foreground hover:text-primary transition-colors">{stateName}</a></li>
						<li class="text-muted-foreground">/</li>
						<li class="text-foreground font-medium">{cityName}</li>
					</ol>
				</nav>

				<!-- Icon -->
				<div class="text-5xl mb-4">{specialty.icon}</div>

				<!-- H1 -->
				<h1 class="text-5xl md:text-6xl font-bold mb-6 text-foreground leading-tight">
					<span class="text-primary">{specialty.seoTitle}</span> in {cityName}
				</h1>

				<p class="text-xl md:text-2xl text-muted-foreground mb-8 leading-relaxed max-w-3xl">
					Compare {schools.length} top-rated {schools.length === 1 ? 'program' : 'programs'} and find the perfect fit for your family
				</p>

				<!-- Stats -->
				<div class="flex flex-wrap gap-4 mb-8">
					<div class="bg-card/80 backdrop-blur-sm border-2 border-primary/20 rounded-xl px-6 py-4 hover:border-primary/40 transition-colors">
						<div class="text-3xl font-bold text-primary">{schools.length}</div>
						<div class="text-sm text-muted-foreground font-medium">Programs</div>
					</div>
					<div class="bg-card/80 backdrop-blur-sm border-2 border-secondary/20 rounded-xl px-6 py-4 hover:border-secondary/40 transition-colors">
						<div class="text-3xl font-bold text-secondary">{topRatedCount}</div>
						<div class="text-sm text-muted-foreground font-medium">Top Rated (4.5+)</div>
					</div>
					<div class="bg-card/80 backdrop-blur-sm border-2 border-accent/20 rounded-xl px-6 py-4 hover:border-accent/40 transition-colors">
						<div class="text-3xl font-bold text-accent">{uniqueCategories.length}</div>
						<div class="text-sm text-muted-foreground font-medium">Specialties</div>
					</div>
				</div>
			</div>
		</Section>
	</div>

	<!-- Quick Benefits Bar -->
	<div class="bg-muted/30 py-8">
		<Section>
			<div class="flex flex-wrap gap-4 justify-center text-sm max-w-4xl mx-auto">
				{specialty.benefits.slice(0, 3).map(benefit => (
					<span class="flex items-center gap-2 bg-card px-4 py-2 rounded-full border border-border/50">
						<span class="text-primary text-lg">‚úì</span>
						<span class="font-medium">{benefit}</span>
					</span>
				))}
			</div>
		</Section>
	</div>

	<!-- All Schools Grid -->
	<Section class="py-16 bg-background">
		<h2 class="text-3xl font-bold mb-8">All {specialty.seoTitle} Programs in {cityName}</h2>

		<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
			{sortedSchools.map((school: any) => (
				<Card class="hover:shadow-xl transition-shadow h-full flex flex-col">
					<CardHeader>
						<div class="flex items-start justify-between mb-3">
							<div class="text-4xl">
								{school.specialFeatures.includes('On-Site Childcare') ? 'üë®‚Äçüë©‚Äçüëß' : 'üèä‚Äç‚ôÄÔ∏è'}
							</div>
							{school.rating > 0 && (
								<Badge variant="secondary" class="text-xs">
									‚≠ê {school.rating.toFixed(1)}
								</Badge>
							)}
						</div>
						<CardTitle>
							<a href={`/${stateSlug}/${citySlug}/${school.id}`} class="hover:text-primary transition-colors">
								{school.name}
							</a>
						</CardTitle>
						<CardDescription>
							<div class="mt-2 mb-3">
								<div class="text-xs text-muted-foreground mb-2">{school.facilityType}</div>
								<div class="flex flex-wrap gap-1">
									{school.categories.slice(0, 2).map((cat: string) => (
										<Badge variant="outline" class="text-xs">
											{cat}
										</Badge>
									))}
									{school.categories.length > 2 && (
										<Badge variant="outline" class="text-xs">
											+{school.categories.length - 2}
										</Badge>
									)}
								</div>
							</div>
						</CardDescription>
					</CardHeader>
					<CardContent class="flex-grow flex flex-col">
						<p class="text-sm text-muted-foreground mb-4 line-clamp-3 flex-grow">
							{school.shortDescription}
						</p>

						<!-- Quick Info -->
						<div class="space-y-2 mb-4 text-xs">
							{school.phone && (
								<div class="flex items-center gap-2 text-muted-foreground">
									<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
									</svg>
									{school.phone}
								</div>
							)}
							{school.priceTier && school.priceTier !== 'Not Specified' && (
								<div class="flex items-center gap-2 text-muted-foreground">
									<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<line x1="12" x2="12" y1="2" y2="22"></line>
										<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
									</svg>
									{school.priceTier}
								</div>
							)}
							{school.hours && (
								<div class="flex items-center gap-2 text-muted-foreground">
									<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="12" cy="12" r="10"></circle>
										<polyline points="12 6 12 12 16 14"></polyline>
									</svg>
									{school.hours}
								</div>
							)}
						</div>

						<Button variant="outline" href={`/${stateSlug}/${citySlug}/${school.id}`} class="w-full">
							View Details
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M5 12h14"></path>
								<path d="m12 5 7 7-7 7"></path>
							</svg>
						</Button>
					</CardContent>
				</Card>
			))}
		</div>
	</Section>

	<!-- Related Specialties Section -->
	{relatedSpecialties.length > 0 && (
		<Section class="py-16 bg-muted/30">
			<div class="max-w-4xl mx-auto">
				<h3 class="text-2xl font-bold mb-6 text-center">Other Programs in {cityName}</h3>
				<p class="text-muted-foreground text-center mb-8">
					Explore additional swim lesson specialties available in {cityName}
				</p>

				<div class="grid md:grid-cols-3 gap-4">
					{relatedSpecialties.map(relatedSpecialty => (
						<a
							href={`/${relatedSpecialty.slug}/${stateSlug}/${citySlug}`}
							class={`${relatedSpecialty.color} rounded-xl p-6 text-center hover:scale-105 transition-transform border border-border/50 hover:border-primary/30 hover:shadow-md block`}
						>
							<div class="text-4xl mb-3">{relatedSpecialty.icon}</div>
							<div class="font-medium text-sm text-foreground">{relatedSpecialty.name}</div>
						</a>
					))}
				</div>
			</div>
		</Section>
	)}

	<!-- CTA Section -->
	<Section class="py-16 bg-gradient-to-br from-primary/5 via-accent/5 to-secondary/5">
		<div class="max-w-3xl mx-auto text-center">
			<h2 class="text-3xl md:text-4xl font-bold mb-4">
				Can't Find What You're Looking For?
			</h2>
			<p class="text-lg text-muted-foreground mb-6">
				Explore all {specialty.seoTitle.toLowerCase()} programs in {stateName} or browse other cities
			</p>
			<div class="flex flex-wrap gap-3 justify-center">
				<Button size="lg" variant="outline" href={`/${specialty.slug}/${stateSlug}`}>
					All {specialty.name} in {stateName}
				</Button>
				<Button size="lg" variant="outline" href={`/${stateSlug}/${citySlug}`}>
					All Programs in {cityName}
				</Button>
			</div>
		</div>
	</Section>
</Layout>
