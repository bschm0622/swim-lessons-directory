---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/ui/Section.astro";
import Card from "@/components/ui/Card.astro";
import CardHeader from "@/components/ui/CardHeader.astro";
import CardTitle from "@/components/ui/CardTitle.astro";
import CardDescription from "@/components/ui/CardDescription.astro";
import CardContent from "@/components/ui/CardContent.astro";
import Badge from "@/components/ui/Badge.astro";
import Button from "@/components/ui/Button.astro";
import SchemaMarkup from "@/components/SchemaMarkup.astro";
import allSchools from "@/data/swim-schools.json";
import { getSpecialtyByCategoryName } from "@/utils/specialty";

export async function getStaticPaths() {
	// Extract unique state/city combinations
	const cityMap = new Map();

	allSchools.forEach(school => {
		const addressParts = school.address.split(',').map(p => p.trim());
		const city = addressParts[addressParts.length - 3] || '';
		const stateWithZip = addressParts[addressParts.length - 2] || '';
		const stateAbbrev = stateWithZip.split(' ')[0];

		if (city && stateAbbrev) {
			// Map state abbreviations to full names
			const stateNames: Record<string, string> = {
				'IN': 'Indiana',
				'TX': 'Texas',
				'CA': 'California',
				'NY': 'New York',
				'FL': 'Florida',
				// Add more as needed
			};

			const stateName = stateNames[stateAbbrev] || stateAbbrev;
			const stateSlug = stateName.toLowerCase().replace(/\s+/g, '-');
			const citySlug = city.toLowerCase().replace(/\s+/g, '-');
			const key = `${stateSlug}/${citySlug}`;

			if (!cityMap.has(key)) {
				cityMap.set(key, {
					stateName,
					stateSlug,
					stateAbbrev,
					cityName: city,
					citySlug,
					schools: []
				});
			}

			cityMap.get(key).schools.push(school);
		}
	});

	return Array.from(cityMap.values()).map(cityData => ({
		params: { state: cityData.stateSlug, city: cityData.citySlug },
		props: { cityData }
	}));
}

const { cityData } = Astro.props;

// Sort schools by rating
const schools = cityData.schools.sort((a, b) => b.rating - a.rating);

// Extract unique categories from these schools
const allCategories = new Set<string>();
schools.forEach(school => {
	school.categories.forEach(cat => allCategories.add(cat));
});
const categories = Array.from(allCategories);

// Get specialty info for filter buttons
const availableSpecialties = Array.from(allCategories)
	.map(cat => getSpecialtyByCategoryName(cat))
	.filter(s => s !== undefined)
	.sort((a, b) => a.name.localeCompare(b.name));
---

<Layout
	title={`Swim Lessons in ${cityData.cityName}, ${cityData.stateAbbrev} - ${schools.length} Programs`}
	description={`Find the best swim lessons in ${cityData.cityName}, ${cityData.stateName}. Compare ${schools.length} programs, read reviews, and choose the perfect swim school for your family.`}
>
	<!-- Schema Markup for SEO -->
	<SchemaMarkup
		type="breadcrumb"
		slot="head"
		breadcrumbs={[
			{ name: 'Home', url: '/' },
			{ name: cityData.stateName, url: `/${cityData.stateSlug}` },
			{ name: cityData.cityName, url: `/${cityData.stateSlug}/${cityData.citySlug}` }
		]}
	/>

	<!-- Compact Header -->
	<div class="border-b border-border bg-background">
		<Section class="py-6">
			<!-- Breadcrumb -->
			<nav class="mb-4 text-sm">
				<ol class="flex items-center gap-2 flex-wrap">
					<li><a href="/" class="text-muted-foreground hover:text-primary">Home</a></li>
					<li class="text-muted-foreground">/</li>
					<li><a href={`/${cityData.stateSlug}`} class="text-muted-foreground hover:text-primary">{cityData.stateName}</a></li>
					<li class="text-muted-foreground">/</li>
					<li class="text-foreground font-medium">{cityData.cityName}</li>
				</ol>
			</nav>

			<h1 class="text-3xl md:text-4xl font-bold mb-2 text-foreground">
				Swim Lessons in {cityData.cityName}, {cityData.stateAbbrev}
			</h1>

			<p class="text-base text-muted-foreground mb-4">
				{schools.length} {schools.length === 1 ? 'program' : 'programs'} • {schools.filter(s => s.rating >= 4.5).length} top-rated (4.5+) • {categories.length} specialties
			</p>

			{categories.length > 0 && (
				<div class="flex flex-wrap gap-2">
					{categories.map(cat => (
						<Badge variant="outline" class="text-xs">{cat}</Badge>
					))}
				</div>
			)}
		</Section>
	</div>

	<!-- Filter by Specialty Section -->
	{availableSpecialties.length > 1 && (
		<Section class="py-5 bg-muted/10 border-b border-border">
			<div class="flex items-center gap-3 mb-3">
				<h2 class="text-sm font-semibold text-muted-foreground">Filter by specialty:</h2>
			</div>
			<div class="flex flex-wrap gap-2">
				{availableSpecialties.map(specialty => (
					<a
						href={`/${specialty.slug}/${cityData.stateSlug}/${cityData.citySlug}`}
						class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-card border border-border hover:border-primary text-xs"
					>
						<img src={specialty.icon} alt={specialty.name} class="w-4 h-4 object-contain" />
						<span>{specialty.name}</span>
					</a>
				))}
			</div>
		</Section>
	)}

	<!-- Schools Grid -->
	<Section class="py-8 bg-background">
		<div class="flex items-center justify-between mb-6">
			<h2 class="text-2xl font-bold">{schools.length} Swim {schools.length === 1 ? 'Program' : 'Programs'}</h2>
			<span class="text-sm text-muted-foreground">Sorted by rating</span>
		</div>

		<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
			{schools.map(school => (
				<Card class="hover:shadow-md h-full flex flex-col">
					<CardHeader class="pb-3">
						<div class="flex items-start justify-between gap-3 mb-2">
							<CardTitle class="text-lg leading-tight">
								<a href={`/${cityData.stateSlug}/${cityData.citySlug}/${school.id}`} class="hover:text-primary">
									{school.name}
								</a>
							</CardTitle>
							{school.rating > 0 && (
								<Badge variant="secondary" class="text-xs flex-shrink-0">
									⭐ {school.rating.toFixed(1)}
								</Badge>
							)}
						</div>
						<p class="text-xs text-muted-foreground">{school.facilityType}</p>
					</CardHeader>

					<CardContent class="flex-grow flex flex-col pt-0">
						<p class="text-sm text-muted-foreground mb-3 line-clamp-2">
							{school.shortDescription}
						</p>

						<!-- Key Info -->
						<div class="space-y-1.5 mb-3 text-xs">
							{school.phone && (
								<div class="flex items-center gap-2 text-foreground">
									<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0">
										<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
									</svg>
									<span>{school.phone}</span>
								</div>
							)}
							{school.priceTier && school.priceTier !== 'Not Specified' && (
								<div class="flex items-center gap-2 text-foreground">
									<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0">
										<line x1="12" x2="12" y1="2" y2="22"></line>
										<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
									</svg>
									<span>{school.priceTier}</span>
								</div>
							)}
							{school.hours && (
								<div class="flex items-center gap-2 text-foreground">
									<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0">
										<circle cx="12" cy="12" r="10"></circle>
										<polyline points="12 6 12 12 16 14"></polyline>
									</svg>
									<span class="line-clamp-1">{school.hours}</span>
								</div>
							)}
						</div>

						<!-- Categories -->
						<div class="flex flex-wrap gap-1 mb-3 mt-auto">
							{school.categories.slice(0, 2).map(cat => (
								<Badge variant="outline" class="text-xs">
									{cat}
								</Badge>
							))}
							{school.categories.length > 2 && (
								<Badge variant="outline" class="text-xs">
									+{school.categories.length - 2}
								</Badge>
							)}
						</div>

						<Button variant="outline" href={`/${cityData.stateSlug}/${cityData.citySlug}/${school.id}`} size="sm" class="w-full">
							View Details
						</Button>
					</CardContent>
				</Card>
			))}
		</div>
	</Section>

	<!-- Footer Navigation -->
	<Section class="py-8 border-t border-border bg-muted/10">
		<div class="text-center">
			<p class="text-sm text-muted-foreground mb-4">
				Looking for programs in other cities?
			</p>
			<Button variant="outline" href={`/${cityData.stateSlug}`}>
				View all {cityData.stateName} programs →
			</Button>
		</div>
	</Section>
</Layout>
